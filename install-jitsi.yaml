type: update
name: Install Jitsi Server
  
onInstall:
  - log: Install updates + repo
  - cmd[debian-vps]:
    - wget -qO - https://download.jitsi.org/jitsi-key.gpg.key | sudo apt-key add -
    - sh -c "echo 'deb https://download.jitsi.org stable/' > /etc/apt/sources.list.d/jitsi-stable.list"
    - apt-get -y update
    - sleep 30s
#    - apt-get -y upgrade
#    - sleep 30s

  - log: Install Jisti
  - cmd[debian-vps]:
    - touch /root/test
    - echo "jitsi-videobridge jitsi-videobridge/jvb-hostname string ${env.domain}" | debconf-set-selections
    - echo "jitsi-meet jitsi-meet/cert-choice select Self-signed certificate will be generated" | debconf-set-selections
    - apt-get -y install jitsi-meet
    - sed -i 's/$EMAIL/${user.email}/g' /usr/share/jitsi-meet/scripts/install-letsencrypt-cert.sh
    - sed -i '21,22d' /usr/share/jitsi-meet/scripts/install-letsencrypt-cert.sh
#    - /usr/share/jitsi-meet/scripts/install-letsencrypt-cert.sh

  - restartContainers:
    - nodeType: debian-vps
